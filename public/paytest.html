<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>إتمام الدفع</title>
    <script src="https://secure-iraq.paytabs.com/payment/js/paylib.js"></script>
    <style>
      body {
        background-color: #f9fafb;
        font-family: 'Tajawal', sans-serif;
      }
      .container {
        max-width: 700px;
        background: white;
        margin: 30px auto;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }
      h1 {
        font-size: 20px;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
      }
      .summary {
        background: #f8f9fa;
        padding: 15px;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        margin-bottom: 20px;
        font-size: 14px;
        color: #444;
      }
      .summary div {
        display: flex;
        justify-content: space-between;
        margin-bottom: 6px;
      }
      .summary div:last-child {
        margin-top: 10px;
        font-weight: bold;
        color: #0a7b20;
        border-top: 1px solid #ccc;
        padding-top: 8px;
      }
      input {
        width: 100%;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 10px;
        margin-top: 5px;
        margin-bottom: 15px;
        font-size: 14px;
      }
      button {
        width: 100%;
        background: black;
        color: white;
        border: none;
        padding: 12px;
        font-size: 15px;
        border-radius: 8px;
        cursor: pointer;
        transition: 0.2s;
      }
      button:hover {
        opacity: 0.9;
      }
      .error {
        color: red;
        background: #ffe6e6;
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 10px;
        font-size: 13px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>إتمام الدفع</h1>

      <div class="summary">
        <div><span>الزبون</span><span id="name">عبد الرحمن</span></div>
        <div><span>الهاتف</span><span id="phone">07812345678</span></div>
        <div><span>العنوان</span><span id="address">بغداد - الكرادة</span></div>
        <div><span>المجموع الفرعي</span><span id="subtotal">25,000 د.ع</span></div>
        <div><span>التوصيل</span><span id="shipping">5,000 د.ع</span></div>
        <div><span>الإجمالي بعد الخصم</span><span id="total">30,000 د.ع</span></div>
      </div>

      <form id="payform" method="POST">
        <input type="hidden" name="payment_token" id="payment_token" />

        <label>رقم البطاقة</label>
        <input type="text" data-paylib="number" placeholder="4111 1111 1111 1111" required />

        <div style="display: flex; gap: 10px">
          <div style="flex: 1">
            <label>الشهر</label>
            <input type="text" data-paylib="expmonth" placeholder="MM" required />
          </div>
          <div style="flex: 1">
            <label>السنة</label>
            <input type="text" data-paylib="expyear" placeholder="YY" required />
          </div>
          <div style="flex: 1">
            <label>CVV</label>
            <input type="text" data-paylib="cvv" placeholder="123" required />
          </div>
        </div>

        <div id="paymentErrors" class="error" style="display: none"></div>

        <button type="button" id="payBtn">تأكيد الدفع</button>
      </form>
    </div>

    <script>
      const name = document.getElementById('name').innerText;
      const phone = document.getElementById('phone').innerText;
      const total = 30000;
      const cartKey = 'cart_123';
      const errorBox = document.getElementById('paymentErrors');

      document.getElementById('payBtn').addEventListener('click', async () => {
        const paylib = window.paylib;
        const form = document.getElementById('payform');

        if (!paylib) {
          showError('Paylib library not loaded yet, please reload the page.');
          return;
        }

        if (!form) {
          showError('Payment form not found.');
          return;
        }

        errorBox.style.display = 'none';

        paylib.inlineForm({
          key: 'C7K2B9-V9276N-M2VQP2-NN6BKM',
          form,
          autoSubmit: false,
          callback: async response => {
            if (response.error) {
              showError(response.message || 'Payment failed');
              return;
            }

            if (!response.payment_token) {
              showError('Payment token not generated');
              return;
            }

            document.getElementById('payment_token').value = response.payment_token;

            try {
              const res = await fetch('/api/storev2/payment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  payment_token: response.payment_token,
                  amount: total,
                  cart_id: cartKey,
                  description: `New order from ${name} (${phone})`,
                }),
              });

              const data = await res.json();
              if (!res.ok || !data.success) {
                showError(data.message || 'Payment processing failed');
                return;
              }

              alert('Payment processed successfully!');
              window.location.href = '/storev2/success';
            } catch (err) {
              showError('Server error while processing payment');
              console.error(err);
            }
          },
        });
      });

      function showError(msg) {
        errorBox.innerText = msg;
        errorBox.style.display = 'block';
      }
    </script>
  </body>
</html>
